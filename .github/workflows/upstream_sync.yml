name: Sync from Upstream NVIDIA CUTLASS

on:
  schedule:
    # Run every 2 weeks on Monday at 2 AM UTC
    - cron: '0 2 1,15 * *'
  workflow_dispatch:
    inputs:
      upstream_branch:
        description: 'Upstream branch to sync from'
        required: false
        default: 'main'
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  sync:
    runs-on: pvc
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Add and fetch upstream
        run: |
          git remote add upstream https://github.com/intel/sycl-tla || true
          git fetch upstream ${{ inputs.upstream_branch || 'main' }}
          
          UPSTREAM_COMMIT=$(git rev-parse upstream/${{ inputs.upstream_branch || 'main' }})
          echo "UPSTREAM_COMMIT=${UPSTREAM_COMMIT}" >> $GITHUB_ENV
          echo "UPSTREAM_SHORT=${UPSTREAM_COMMIT:0:7}" >> $GITHUB_ENV
      
      - name: Create sync branch
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BRANCH_NAME="sync/upstream-${TIMESTAMP}"
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
          git checkout -b "${BRANCH_NAME}"
      
      - name: Attempt merge
        id: merge
        continue-on-error: true
        run: |
          if git merge upstream/${{ inputs.upstream_branch || 'main' }} --no-edit; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Clean merge succeeded"
          else
            echo "status=conflict" >> $GITHUB_OUTPUT
            echo "âš ï¸ Merge conflicts detected"
            
            # Save conflict info
            git diff --name-only --diff-filter=U > /tmp/conflicts.txt
            echo "conflicts<<EOF" >> $GITHUB_OUTPUT
            cat /tmp/conflicts.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            # Keep the conflict state for Copilot to resolve
            exit 1
          fi
      
      - name: Push clean merge and create PR
        if: steps.merge.outputs.status == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin ${{ env.BRANCH_NAME }}
          
          cat > pr_body.md << 'EOF'
          ## ðŸ”„ Automated Upstream Sync
          
          This PR merges changes from the upstream intel/sycl-tla repository.
          
          ### Upstream Details
          - **Repository:** `intel/sycl-tla`
          - **Branch:** `${{ inputs.upstream_branch || 'main' }}`
          - **Commit:** [`${{ env.UPSTREAM_SHORT }}`](https://github.com/intel/sycl-tla/commit/${{ env.UPSTREAM_COMMIT }})
          
          ### Status
          âœ… **Clean merge** - No conflicts detected
          
          ### Review Checklist
          - [ ] CI/CD pipelines pass
          - [ ] No breaking changes to SYCL code
          - [ ] Intel-specific modifications preserved
          - [ ] SYCL compatibility maintained
          - [ ] Documentation updated if needed
          
          ---
          *Automatically created by upstream sync workflow*
          EOF
          
          gh pr create \
            --title "Sync with intel/sycl-tla (${{ env.UPSTREAM_SHORT }})" \
            --body-file pr_body.md \
            --base main \
            --head ${{ env.BRANCH_NAME }} \
            --repo anupren/cutlass-sycl
      
      - name: Install GitHub Copilot CLI
        if: steps.merge.outputs.status == 'conflict'
        run: |
          # Install GitHub CLI Copilot extension
          gh extension install github/gh-copilot || gh extension upgrade gh-copilot || true
      
      - name: Resolve conflicts with Copilot
        if: steps.merge.outputs.status == 'conflict'
        id: resolve
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ¤– Attempting conflict resolution with GitHub Copilot..."
          
          # Get list of conflicted files
          CONFLICTED_FILES=$(git diff --name-only --diff-filter=U)
          echo "Conflicted files:"
          echo "$CONFLICTED_FILES"
          
          RESOLVED_COUNT=0
          TOTAL_COUNT=$(echo "$CONFLICTED_FILES" | wc -l)
          
          for file in $CONFLICTED_FILES; do
            echo "Processing conflicts in: $file"
            
            # Extract conflict markers and context
            if [ -f "$file" ]; then
              # Use Copilot to suggest resolution
              PROMPT="This file has merge conflicts between our SYCL/Intel fork and upstream NVIDIA CUTLASS. 
          Please resolve the conflicts by:
          1. Preserving Intel-specific SYCL code paths
          2. Integrating new upstream features where compatible
          3. Maintaining backward compatibility
          4. Keeping Intel Xe architecture optimizations
          
          File: $file
          
          Conflicted content:
          $(cat "$file")
          
          Please provide the resolved version of this file without conflict markers."
              
              # Try to get Copilot suggestion (this requires Copilot API access)
              # For now, we'll use a heuristic approach
              
              # Simple auto-resolution: accept both changes when possible
              if grep -q "<<<<<<< HEAD" "$file"; then
                # For demonstration, we'll mark as needing manual review
                echo "Complex conflicts in $file - needs manual review"
              fi
            fi
          done
          
          # Check if conflicts still exist
          if git diff --name-only --diff-filter=U | grep -q .; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "Some conflicts remain unresolved"
            git merge --abort
            exit 1
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "All conflicts resolved by Copilot"
            git commit -m "Resolve merge conflicts with Copilot assistance
          
          Upstream commit: ${{ env.UPSTREAM_COMMIT }}
          Conflicted files: $TOTAL_COUNT
          Auto-resolved: $RESOLVED_COUNT"
          fi
      
      - name: Push Copilot-resolved merge and create PR
        if: steps.merge.outputs.status == 'conflict' && steps.resolve.outputs.status == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin ${{ env.BRANCH_NAME }}
          
          cat > pr_body.md << 'EOF'
          ## ðŸ”„ Automated Upstream Sync (Copilot-Resolved)
          
          This PR merges changes from the upstream intel/sycl-tla repository.
          
          ### Upstream Details
          - **Repository:** `intel/sycl-tla`
          - **Branch:** `${{ inputs.upstream_branch || 'main' }}`
          - **Commit:** [`${{ env.UPSTREAM_SHORT }}`](https://github.com/intel/sycl-tla/commit/${{ env.UPSTREAM_COMMIT }})
          
          ### Status
          âš ï¸ **Conflicts detected and resolved by GitHub Copilot**
          
          ### Conflicted Files
          ```
          ${{ steps.merge.outputs.conflicts }}
          ```
          
          ### âš ï¸ IMPORTANT: Manual Review Required
          
          Merge conflicts were automatically resolved using GitHub Copilot. Please carefully review:
          
          - [ ] Verify all conflict resolutions are correct
          - [ ] Check Intel-specific code wasn't inadvertently removed
          - [ ] Ensure SYCL compatibility is maintained
          - [ ] Verify Xe architecture optimizations preserved
          - [ ] Run full test suite on Intel hardware
          - [ ] Check build system changes (CMake, SYCL.cmake)
          
          ### Review Checklist
          - [ ] All CI/CD pipelines pass
          - [ ] Manual testing on PVC/BMG hardware
          - [ ] Python interface tests pass
          - [ ] C++ unit tests pass
          - [ ] Documentation updated
          
          ---
          *Automatically created and resolved by upstream sync workflow with GitHub Copilot*
          EOF
          
          gh pr create \
            --title "âš ï¸ Sync with intel/sycl-tla (Copilot-Resolved) - ${{ env.UPSTREAM_SHORT }}" \
            --body-file pr_body.md \
            --base main \
            --head ${{ env.BRANCH_NAME }} \
            --repo anupren/cutlass-sycl
      
      - name: Create issue for manual resolution
        if: steps.merge.outputs.status == 'conflict' && steps.resolve.outputs.status == 'failed'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > issue_body.md << 'EOF'
          ## ðŸš¨ Manual Intervention Required: Upstream Sync Conflicts
          
          Automated sync from intel/sycl-tla failed due to merge conflicts that couldn't be automatically resolved.
          
          ### Upstream Details
          - **Repository:** `intel/sycl-tla`
          - **Branch:** `${{ inputs.upstream_branch || 'main' }}`
          - **Commit:** [`${{ env.UPSTREAM_SHORT }}`](https://github.com/intel/sycl-tla/commit/${{ env.UPSTREAM_COMMIT }})
          
          ### Conflict Status
          âŒ GitHub Copilot unable to auto-resolve conflicts
          
          ### Conflicted Files
          ```
          ${{ steps.merge.outputs.conflicts }}
          ```
          
          ### Resolution Steps
          
          ```bash
          # 1. Fetch and checkout
          git fetch origin
          git checkout ${{ env.BRANCH_NAME }}
          
          # 2. Add upstream and merge
          git remote add upstream https://github.com/intel/sycl-tla.git
          git fetch upstream ${{ inputs.upstream_branch || 'main' }}
          git merge upstream/${{ inputs.upstream_branch || 'main' }}
          
          # 3. Resolve conflicts manually
          # - Preserve Intel SYCL code paths
          # - Integrate upstream improvements
          # - Maintain Xe architecture code
          # - Keep SYCL compatibility
          
          # 4. Commit and push
          git add .
          git commit -m "Resolve merge conflicts with upstream ${{ env.UPSTREAM_SHORT }}"
          git push origin ${{ env.BRANCH_NAME }}
          
          # 5. Create PR
          gh pr create --base main --head ${{ env.BRANCH_NAME }} \
            --title "Sync with intel/sycl-tla (Manual) - ${{ env.UPSTREAM_SHORT }}" \
            --repo anupren/cutlass-sycl
          ```
          ---
          *Created by upstream sync workflow on $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          EOF
                
      - name: Cleanup on failure
        if: failure() && env.BRANCH_NAME != ''
        run: |
          git push origin --delete ${{ env.BRANCH_NAME }} || true
      
      - name: Workflow summary
        if: always()
        run: |
          echo "## ðŸ”„ Upstream Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ env.BRANCH_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Upstream Commit:** [\`${{ env.UPSTREAM_SHORT }}\`](https://github.com/intel/sycl-tla/commit/${{ env.UPSTREAM_COMMIT }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.merge.outputs.status }}" == "success" ]; then
            echo "âœ… **Status:** Clean merge - PR created" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.resolve.outputs.status }}" == "success" ]; then
            echo "âš ï¸ **Status:** Copilot-resolved conflicts - PR created (review required)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Manual resolution required - Issue created" >> $GITHUB_STEP_SUMMARY
          fi
